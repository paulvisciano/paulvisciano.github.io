<!DOCTYPE html>
<html>
<head>
    <title>Jarvis Neural Mind</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: #0a1128; 
            color: #00ffff; 
            font-family: monospace; 
            overflow: hidden;
        }
        canvas { 
            display: block; 
            margin-right: 240px;
            background: radial-gradient(ellipse at center, #0f1a3a 0%, #0a0f20 50%, #000000 100%);
            filter: brightness(1.1);
            touch-action: none;
        }
        #info { 
            position: fixed; 
            right: 0; 
            top: 0; 
            width: 240px; 
            height: 100vh; 
            background: rgba(10, 17, 40, 0.98); 
            padding: 18px; 
            border-left: 2px solid #00ffff;
            font-size: 11px; 
            overflow: hidden;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.15);
            z-index: 10;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        #info .panel-top { flex: 1 1 auto; min-height: 0; display: flex; flex-direction: column; }
        #info .panel-top .panel-top-content { flex: 0 0 auto; }
        #info .panel-top .panel-buttons { flex: 1 1 auto; min-height: 80px; }
        #info .panel-legend { flex: 0 0 auto; padding-top: 20px; border-top: 1px solid rgba(0, 255, 255, 0.3); }
        h3 { 
            margin: 18px 0 10px 0; 
            color: #00ffff; 
            font-size: 14px;
            text-shadow: 0 0 15px #00ffff, 0 0 30px #0088ff;
            font-weight: bold;
        }
        p { margin: 5px 0; line-height: 1.5; }
        button { 
            background: linear-gradient(135deg, #0088ff, #00ffff); 
            color: #000; 
            padding: 10px 14px; 
            margin: 10px 0; 
            border: 0; 
            cursor: pointer;
            border-radius: 4px;
            font-weight: bold;
            font-family: monospace;
            transition: all 0.3s;
            width: 100%;
            box-shadow: 0 0 10px #0088ff;
        }
        button:hover { 
            background: linear-gradient(135deg, #00ffff, #00ffff);
            box-shadow: 0 0 25px #00ffff;
            transform: scale(1.02);
        }
        .stat { color: #00ffff; font-weight: bold; text-shadow: 0 0 10px #00ffff; }
        .desc { color: #0088ff; font-size: 9px; }
        #detailPanel {
            height: 200px;
            min-height: 200px;
            overflow-y: auto;
            margin-top: 16px;
            padding-top: 10px;
            border-top: 1px solid #00ffff;
            -webkit-overflow-scrolling: touch;
        }
        #detailPanel.is-empty {
            visibility: hidden;
        }
        .panel-buttons {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(0, 255, 255, 0.5);
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div id="info">
        <div class="panel-top">
        <div class="panel-top-content">
        <h3>‚ö° Neural Mind</h3>
        <p class="desc">Your memories. Alive. Connected.</p>
        <p style="margin-top: 15px; font-size: 12px;">
            <span class="stat" id="status">‚Äî</span>
        </p>
        <p style="margin-top: 15px; font-size: 10px; line-height: 1.7; color: #0088ff;">
            üñ±Ô∏è Drag to orbit<br>
            üìú Scroll to zoom<br>
            üëÜ Click to focus<br>
        </p>
        <p style="margin-top: 15px;">
            <span class="stat" id="count">0</span> <span class="desc">neurons active</span>
        </p>
        
        <div id="detailPanel" class="is-empty">
            <h3 style="color: #00ffff; font-size: 14px; margin-bottom: 8px;">Info</h3>
            <div id="nodeDetails" style="font-size: 10px; line-height: 1.8;">
                <p id="detailName" style="color: #ffff00; font-weight: bold; margin-bottom: 6px;"></p>
                <p id="detailType" style="color: #00ffff;"></p>
                <p id="detailDesc" style="color: #aaaaaa; font-style: italic; margin-top: 8px; margin-bottom: 10px;"></p>
                <p style="color: #00ffff; margin-top: 10px; margin-bottom: 6px; font-weight: bold;">Connected To</p>
                <div id="detailConnections" style="font-size: 9px; color: #888;"></div>
            </div>
        </div>
        </div>
        
        <div class="panel-buttons">
            <button onclick="walk()" style="margin-top: 0;">‚ö° Random Pulse</button>
            <button onclick="reset()">‚Üª Reset Mind</button>
        </div>
        </div>
        
        <div class="panel-legend">
        <h3 style="margin-bottom: 10px;">Legend</h3>
        <div style="font-size: 10px; line-height: 2.2; margin-top: 0;">
            <div style="display: flex; align-items: center; margin: 6px 0;">
                <div style="width: 12px; height: 12px; background: #00ffff; border-radius: 50%; margin-right: 8px; box-shadow: 0 0 8px #00ffff;"></div>
                <span style="color: #00ffff;">Activities</span>
            </div>
            <div style="display: flex; align-items: center; margin: 6px 0;">
                <div style="width: 12px; height: 12px; background: #ff00aa; border-radius: 50%; margin-right: 8px; box-shadow: 0 0 8px #ff00aa;"></div>
                <span style="color: #ff00aa;">People</span>
            </div>
            <div style="display: flex; align-items: center; margin: 6px 0;">
                <div style="width: 12px; height: 12px; background: #00ff88; border-radius: 50%; margin-right: 8px; box-shadow: 0 0 8px #00ff88;"></div>
                <span style="color: #00ff88;">Locations</span>
            </div>
            <div style="display: flex; align-items: center; margin: 6px 0;">
                <div style="width: 12px; height: 12px; background: #ffaa00; border-radius: 50%; margin-right: 8px; box-shadow: 0 0 8px #ffaa00;"></div>
                <span style="color: #ffaa00;">Temporal</span>
            </div>
            <div style="display: flex; align-items: center; margin: 6px 0;">
                <div style="width: 12px; height: 12px; background: #aa00ff; border-radius: 50%; margin-right: 8px; box-shadow: 0 0 8px #aa00ff;"></div>
                <span style="color: #aa00ff;">Emotions</span>
            </div>
        </div>
        </div>
    </div>
    <canvas id="canvas"></canvas>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', {alpha: true});
        
        canvas.width = window.innerWidth - 240;
        canvas.height = window.innerHeight;

        const nodes = [
            // Core activities
            {id: 0, name: 'Volleyball', type: 'activity', x: 0, y: 0, z: 0, vx: 0, vy: 0, vz: 0, size: 14, color: '#00ffff', glow: 30, freq: 12, desc: '18 years competition, crew connections, flow state'},
            {id: 1, name: 'Running', type: 'activity', x: 100, y: -80, z: -60, vx: 0, vy: 0, vz: 0, size: 8, color: '#00ffff', glow: 18, freq: 6, desc: 'Urban exploration, morning ritual, endurance'},
            {id: 2, name: 'Cooking', type: 'activity', x: -120, y: 60, z: -80, vx: 0, vy: 0, vz: 0, size: 9, color: '#00ffff', glow: 20, freq: 7, desc: 'Shared meals, intimate moments, care'},
            {id: 3, name: 'Gym', type: 'activity', x: 140, y: 50, z: 90, vx: 0, vy: 0, vz: 0, size: 8, color: '#00ffff', glow: 18, freq: 6, desc: 'Strength, discipline, daily grounding'},
            {id: 4, name: 'Golf', type: 'activity', x: -80, y: 120, z: 60, vx: 0, vy: 0, vz: 0, size: 6, color: '#00ffff', glow: 14, freq: 4, desc: 'Night golf, caddies, crew adventure'},
            {id: 5, name: 'Karaoke', type: 'activity', x: 110, y: 100, z: -80, vx: 0, vy: 0, vz: 0, size: 6, color: '#00ffff', glow: 14, freq: 3, desc: 'Blue-lit lounges, bilingual banter, marriage jokes'},
            {id: 6, name: 'Coffee', type: 'activity', x: 80, y: -100, z: 50, vx: 0, vy: 0, vz: 0, size: 6, color: '#00ffff', glow: 14, freq: 4, desc: 'Daily ritual, espresso obsessed, fuel for exploration'},
            {id: 7, name: 'Work', type: 'temporal', x: -100, y: 100, z: 70, vx: 0, vy: 0, vz: 0, size: 7, color: '#ffaa00', glow: 16, freq: 5, desc: 'Remote OutSystems EU team, early mornings, late nights'},
            
            // People
            {id: 8, name: 'Jeandel', type: 'person', x: 120, y: 80, z: -70, vx: 0, vy: 0, vz: 0, size: 11, color: '#ff00aa', glow: 26, freq: 10, desc: '2+ months Siargao, cooking partner, intimate bond'},
            {id: 9, name: 'Wouter', type: 'person', x: -90, y: 130, z: -100, vx: 0, vy: 0, vz: 0, size: 7, color: '#ff00aa', glow: 16, freq: 5, desc: 'Travel buddy, yoga partner, years of friendship'},
            {id: 10, name: 'Sean', type: 'person', x: 95, y: 90, z: 70, vx: 0, vy: 0, vz: 0, size: 5, color: '#ff00aa', glow: 12, freq: 3, desc: 'Golf crew, caddy Google Translate moments'},
            {id: 11, name: 'Kratae (Cat)', type: 'person', x: 105, y: 75, z: -50, vx: 0, vy: 0, vz: 0, size: 5, color: '#ff00aa', glow: 12, freq: 3, desc: 'Couch moments, karaoke partner, connection'},
            {id: 12, name: 'Maria', type: 'person', x: 100, y: 70, z: 40, vx: 0, vy: 0, vz: 0, size: 5, color: '#ff00aa', glow: 12, freq: 3, desc: 'Gift exchange, Manila connection, sour mangos'},
            {id: 13, name: 'Aime', type: 'person', x: 85, y: 95, z: 30, vx: 0, vy: 0, vz: 0, size: 6, color: '#ff00aa', glow: 14, freq: 4, desc: 'Chinatown walks, cultural guide, riverside moments'},
            {id: 14, name: 'Kratae', type: 'person', x: 100, y: 110, z: -60, vx: 0, vy: 0, vz: 0, size: 5, color: '#ff00aa', glow: 12, freq: 3, desc: 'Siargao presence, couch times, intimacy'},
            
            // Locations
            {id: 15, name: 'Bangkok', type: 'location', x: -60, y: -110, z: 80, vx: 0, vy: 0, vz: 0, size: 11, color: '#00ff88', glow: 24, freq: 8, desc: 'Primary base, 6+ weeks, Urban Runner epicenter'},
            {id: 16, name: 'Siargao', type: 'location', x: 110, y: -120, z: -60, vx: 0, vy: 0, vz: 0, size: 11, color: '#00ff88', glow: 24, freq: 8, desc: 'Island rhythm, Jeandel hub, 2+ months immersion'},
            {id: 17, name: 'Boracay', type: 'location', x: 130, y: -80, z: 100, vx: 0, vy: 0, vz: 0, size: 8, color: '#00ff88', glow: 18, freq: 5, desc: 'Island Boy aesthetic, gym base, Wouter meets'},
            {id: 18, name: 'Botanical Garden', type: 'location', x: 60, y: -130, z: -50, vx: 0, vy: 0, vz: 0, size: 6, color: '#00ff88', glow: 14, freq: 3, desc: 'Wachirabenchathat Park, 11km quest, final checkpoint'},
            {id: 19, name: 'Chicago', type: 'location', x: -140, y: -90, z: -70, vx: 0, vy: 0, vz: 0, size: 8, color: '#00ff88', glow: 18, freq: 5, desc: 'Home base, family reunion, father reconnection'},
            {id: 20, name: 'Miami', type: 'location', x: 70, y: -100, z: 120, vx: 0, vy: 0, vz: 0, size: 8, color: '#00ff88', glow: 18, freq: 5, desc: 'Crew hub, beach volleyball, South Beach culture'},
            {id: 21, name: 'Wallflowers Caf√©', type: 'location', x: 50, y: 60, z: -60, vx: 0, vy: 0, vz: 0, size: 5, color: '#00ff88', glow: 12, freq: 3, desc: 'Multi-floor rooftop, Chinatown dining, Aime moments'},
            {id: 22, name: 'Chinatown', type: 'location', x: 45, y: 65, z: -50, vx: 0, vy: 0, vz: 0, size: 6, color: '#00ff88', glow: 14, freq: 4, desc: 'Main street walks, hidden gems, riverside finale'},
            {id: 23, name: 'Panya Indra Golf Club', type: 'location', x: -75, y: 115, z: 55, vx: 0, vy: 0, vz: 0, size: 5, color: '#00ff88', glow: 12, freq: 3, desc: '1h north Bangkok, night golf, caddie experience'},
            
            // Emotions & States
            {id: 24, name: 'Presence', type: 'emotion', x: -70, y: -90, z: 30, vx: 0, vy: 0, vz: 0, size: 9, color: '#aa00ff', glow: 20, freq: 6, desc: 'Being here, attention, stillness with companions'},
            {id: 25, name: 'Flow', type: 'emotion', x: 50, y: 80, z: -90, vx: 0, vy: 0, vz: 0, size: 7, color: '#aa00ff', glow: 16, freq: 4, desc: 'Absorbed in activity, effortless excellence'},
            {id: 26, name: 'Connection', type: 'emotion', x: -100, y: -50, z: 120, vx: 0, vy: 0, vz: 0, size: 8, color: '#aa00ff', glow: 18, freq: 5, desc: 'Deep bonds, shared experiences, intimacy'},
            {id: 27, name: 'Adaptation', type: 'emotion', x: 30, y: -70, z: 40, vx: 0, vy: 0, vz: 0, size: 6, color: '#aa00ff', glow: 14, freq: 4, desc: 'Flexibility when plans fail, finding beauty in adjustment'},
            {id: 28, name: 'Care', type: 'emotion', x: -50, y: 85, z: -40, vx: 0, vy: 0, vz: 0, size: 7, color: '#aa00ff', glow: 16, freq: 4, desc: 'Cooking moments, gift-giving, attention to others'},
            
            // Additional temporal/states
            {id: 29, name: 'Late-Night', type: 'temporal', x: -120, y: 70, z: 50, vx: 0, vy: 0, vz: 0, size: 6, color: '#ffaa00', glow: 14, freq: 3, desc: 'Work sessions stretched, couch presence, intimacy'},
            {id: 30, name: 'Morning Ritual', type: 'temporal', x: 75, y: -95, z: 55, vx: 0, vy: 0, vz: 0, size: 6, color: '#ffaa00', glow: 14, freq: 3, desc: 'Early wake, coffee, preparation for day'}
        ];

        const edges = [
            // Jeandel (person) connections - primary hub
            {from: 8, to: 16, weight: 10}, // Jeandel ‚Üí Siargao
            {from: 8, to: 2, weight: 9},   // Jeandel ‚Üí Cooking
            {from: 8, to: 24, weight: 8},  // Jeandel ‚Üí Presence
            {from: 8, to: 26, weight: 7},  // Jeandel ‚Üí Connection
            {from: 8, to: 7, weight: 6},   // Jeandel ‚Üí Work (late nights)
            
            // Siargao ecosystem (multiple memories)
            {from: 16, to: 2, weight: 9},  // Siargao ‚Üí Cooking
            {from: 16, to: 7, weight: 7},  // Siargao ‚Üí Work
            {from: 16, to: 24, weight: 8}, // Siargao ‚Üí Presence
            {from: 16, to: 28, weight: 7}, // Siargao ‚Üí Care (Jeandel)
            
            // Bangkok ecosystem
            {from: 15, to: 0, weight: 8},  // Bangkok ‚Üí Volleyball
            {from: 15, to: 1, weight: 7},  // Bangkok ‚Üí Running
            {from: 15, to: 18, weight: 6}, // Bangkok ‚Üí Botanical Garden
            {from: 15, to: 4, weight: 6},  // Bangkok ‚Üí Golf
            {from: 15, to: 5, weight: 5},  // Bangkok ‚Üí Karaoke
            {from: 15, to: 21, weight: 6}, // Bangkok ‚Üí Wallflowers Caf√©
            {from: 15, to: 22, weight: 6}, // Bangkok ‚Üí Chinatown
            
            // Golf night (Episode 20)
            {from: 4, to: 15, weight: 7},  // Golf ‚Üí Bangkok
            {from: 4, to: 10, weight: 6},  // Golf ‚Üí Sean
            {from: 4, to: 23, weight: 8},  // Golf ‚Üí Panya Indra Club
            {from: 5, to: 11, weight: 6},  // Karaoke ‚Üí Kratae (Cat)
            {from: 5, to: 10, weight: 5},  // Karaoke ‚Üí Sean
            
            // Chicago (Episode 1)
            {from: 19, to: 0, weight: 7},  // Chicago ‚Üí Volleyball
            {from: 19, to: 3, weight: 6},  // Chicago ‚Üí Gym
            
            // Miami (Episode 22)
            {from: 20, to: 0, weight: 8},  // Miami ‚Üí Volleyball
            {from: 20, to: 9, weight: 7},  // Miami ‚Üí Wouter
            
            // Boracay (Episode 18)
            {from: 17, to: 9, weight: 8},  // Boracay ‚Üí Wouter
            {from: 17, to: 3, weight: 7},  // Boracay ‚Üí Gym
            {from: 9, to: 3, weight: 6},   // Wouter ‚Üí Gym
            
            // Chinatown & Caf√© (Episode 19)
            {from: 21, to: 22, weight: 8}, // Wallflowers ‚Üí Chinatown
            {from: 22, to: 13, weight: 7}, // Chinatown ‚Üí Aime
            {from: 13, to: 24, weight: 7}, // Aime ‚Üí Presence (walks)
            
            // Activity connections
            {from: 0, to: 3, weight: 7},   // Volleyball ‚Üí Gym
            {from: 1, to: 18, weight: 6},  // Running ‚Üí Botanical Garden
            {from: 2, to: 24, weight: 8},  // Cooking ‚Üí Presence
            {from: 2, to: 28, weight: 8},  // Cooking ‚Üí Care
            {from: 6, to: 7, weight: 6},   // Coffee ‚Üí Work
            {from: 7, to: 29, weight: 7},  // Work ‚Üí Late-Night
            {from: 6, to: 30, weight: 7},  // Coffee ‚Üí Morning Ritual
            
            // Emotion connections
            {from: 24, to: 26, weight: 9}, // Presence ‚Üí Connection
            {from: 24, to: 25, weight: 8}, // Presence ‚Üí Flow
            {from: 26, to: 8, weight: 8},  // Connection ‚Üí Jeandel
            {from: 25, to: 0, weight: 7},  // Flow ‚Üí Volleyball
            {from: 25, to: 3, weight: 6},  // Flow ‚Üí Gym
            {from: 27, to: 24, weight: 7}, // Adaptation ‚Üí Presence
            {from: 28, to: 2, weight: 9},  // Care ‚Üí Cooking
            {from: 28, to: 8, weight: 8},  // Care ‚Üí Jeandel
            
            // Temporal connections
            {from: 29, to: 7, weight: 8},  // Late-Night ‚Üí Work
            {from: 29, to: 28, weight: 7}, // Late-Night ‚Üí Care
            {from: 29, to: 8, weight: 7},  // Late-Night ‚Üí Jeandel
            {from: 30, to: 6, weight: 8},  // Morning ‚Üí Coffee
            {from: 30, to: 1, weight: 7}   // Morning ‚Üí Running
        ];

        let camera = {angle: 0.5, dist: 480, height: 0, pitch: 0};
        let selected = null;
        let time = 0;
        let particles = [];

        function project(x, y, z) {
            const cos = Math.cos(camera.angle);
            const sin = Math.sin(camera.angle);
            const rx = x * cos - z * sin;
            const rz = x * sin + z * cos;
            const cp = Math.cos(camera.pitch);
            const sp = Math.sin(camera.pitch);
            const viewY = y * cp - rz * sp;
            const viewZ = y * sp + rz * cp;
            const scale = camera.dist / (camera.dist + viewZ + 200);
            return {
                x: canvas.width/2 + rx * scale,
                y: canvas.height/2 + (viewY + camera.height) * scale,
                z: viewZ,
                scale: Math.max(0.1, scale)
            };
        }

        function step() {
            // Kill all movement - nodes stay in place
            nodes.forEach(n => {
                n.vx = 0;
                n.vy = 0;
                n.vz = 0;
            });
        }

        function render() {
            try {
                time++;
                
                ctx.fillStyle = '#0a1128';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                const sorted = nodes.map(n => {
                    const p = project(n.x, n.y, n.z);
                    return {node: n, proj: p};
                }).sort((a, b) => a.proj.z - b.proj.z);

                // When a node is selected, only it and its connections stay bright
                let activeNodeIds = null;
                if (selected !== null) {
                    activeNodeIds = new Set([selected]);
                    edges.forEach(e => {
                        if (e.from === selected) activeNodeIds.add(e.to);
                        if (e.to === selected) activeNodeIds.add(e.from);
                    });
                }

                // Draw synapses with triple glow
                edges.forEach(e => {
                    const p1 = project(nodes[e.from].x, nodes[e.from].y, nodes[e.from].z);
                    const p2 = project(nodes[e.to].x, nodes[e.to].y, nodes[e.to].z);
                    const isConnected = selected !== null && (e.from === selected || e.to === selected);
                    const strength = 0.4 + (e.weight / 15) * 0.6;
                    
                    if (isConnected) {
                        // Highlight: connected to selected node ‚Äî yellow/white glow on top
                        ctx.lineCap = 'round';
                        ctx.lineJoin = 'round';
                        ctx.strokeStyle = 'rgba(255, 255, 200, 0.35)';
                        ctx.lineWidth = Math.max(8, e.weight / 1.5) + 4;
                        ctx.beginPath();
                        ctx.moveTo(p1.x, p1.y);
                        ctx.lineTo(p2.x, p2.y);
                        ctx.stroke();
                        ctx.strokeStyle = 'rgba(255, 255, 150, 0.7)';
                        ctx.lineWidth = Math.max(3, e.weight / 2.5) + 1;
                        ctx.beginPath();
                        ctx.moveTo(p1.x, p1.y);
                        ctx.lineTo(p2.x, p2.y);
                        ctx.stroke();
                        ctx.strokeStyle = '#ffff88';
                        ctx.lineWidth = Math.max(1.5, e.weight / 4);
                        ctx.beginPath();
                        ctx.moveTo(p1.x, p1.y);
                        ctx.lineTo(p2.x, p2.y);
                        ctx.stroke();
                    } else {
                        // Default cyan
                        ctx.strokeStyle = `rgba(0, 100, 255, ${strength * 0.2})`;
                        ctx.lineWidth = Math.max(4, e.weight / 2.5) + 2;
                        ctx.lineCap = 'round';
                        ctx.lineJoin = 'round';
                        ctx.beginPath();
                        ctx.moveTo(p1.x, p1.y);
                        ctx.lineTo(p2.x, p2.y);
                        ctx.stroke();
                        ctx.strokeStyle = `rgba(0, 200, 255, ${strength * 0.4})`;
                        ctx.lineWidth = Math.max(2, e.weight / 3.5) + 1;
                        ctx.beginPath();
                        ctx.moveTo(p1.x, p1.y);
                        ctx.lineTo(p2.x, p2.y);
                        ctx.stroke();
                        ctx.strokeStyle = `rgba(0, 255, 255, ${strength})`;
                        ctx.lineWidth = Math.max(0.5, e.weight / 5);
                        ctx.beginPath();
                        ctx.moveTo(p1.x, p1.y);
                        ctx.lineTo(p2.x, p2.y);
                        ctx.stroke();
                    }
                });

                // Draw neurons
                const dimAlpha = 0.22;
                sorted.forEach(item => {
                    const n = item.node;
                    const p = item.proj;
                    const r = n.size * p.scale;
                    const glow = n.glow * p.scale;
                    const isDimmed = activeNodeIds !== null && !activeNodeIds.has(n.id);
                    if (isDimmed) ctx.globalAlpha = dimAlpha;

                    // Outer halo
                    const g1 = ctx.createRadialGradient(p.x, p.y, r*0.5, p.x, p.y, glow*2);
                    const [r2, g2, b2] = [
                        parseInt(n.color.slice(1,3), 16),
                        parseInt(n.color.slice(3,5), 16),
                        parseInt(n.color.slice(5,7), 16)
                    ];
                    g1.addColorStop(0, `rgba(${r2}, ${g2}, ${b2}, 0.6)`);
                    g1.addColorStop(0.5, `rgba(${r2}, ${g2}, ${b2}, 0.15)`);
                    g1.addColorStop(1, `rgba(${r2}, ${g2}, ${b2}, 0)`);
                    ctx.fillStyle = g1;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, glow*2, 0, 6.28);
                    ctx.fill();

                    // Inner glow
                    const g2_grad = ctx.createRadialGradient(p.x, p.y, r*0.2, p.x, p.y, glow);
                    g2_grad.addColorStop(0, `rgba(${r2}, ${g2}, ${b2}, 1)`);
                    g2_grad.addColorStop(0.5, `rgba(${r2}, ${g2}, ${b2}, 0.4)`);
                    g2_grad.addColorStop(1, `rgba(${r2}, ${g2}, ${b2}, 0)`);
                    ctx.fillStyle = g2_grad;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, glow, 0, 6.28);
                    ctx.fill();

                    // Core neuron
                    ctx.fillStyle = n.color;
                    ctx.shadowColor = n.color;
                    ctx.shadowBlur = 25;
                    ctx.shadowOffsetX = 0;
                    ctx.shadowOffsetY = 0;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, r, 0, 6.28);
                    ctx.fill();
                    ctx.shadowBlur = 0;

                    // Selection highlight
                    if (selected === n.id) {
                        ctx.strokeStyle = '#ffff00';
                        ctx.lineWidth = 4;
                        ctx.globalAlpha = 0.9;
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, r + 12, 0, 6.28);
                        ctx.stroke();
                        
                        // Pulsing ring
                        const pulse = Math.sin(time * 0.05) * 0.3 + 0.7;
                        ctx.strokeStyle = `rgba(255, 255, 0, ${pulse * 0.6})`;
                        ctx.lineWidth = 2;
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, r + 20, 0, 6.28);
                        ctx.stroke();
                        ctx.globalAlpha = 1;
                    }

                    // Label with glow
                    ctx.fillStyle = n.color;
                    ctx.font = 'bold 10px monospace';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.shadowColor = n.color;
                    ctx.shadowBlur = 10;
                    ctx.globalAlpha = isDimmed ? dimAlpha * 0.9 : 0.85;
                    ctx.fillText(n.name, p.x, p.y + r + 18);
                    ctx.shadowBlur = 0;
                    ctx.globalAlpha = 1;
                });

                document.getElementById('count').textContent = nodes.length;
                document.getElementById('status').textContent = selected !== null ? `üß† ${nodes[selected].name}` : '‚Äî';

                step();
                requestAnimationFrame(render);
            } catch (e) {
                console.error('Render error:', e);
            }
        }

        canvas.addEventListener('click', e => {
            const rect = canvas.getBoundingClientRect();
            const mx = e.clientX - rect.left;
            const my = e.clientY - rect.top;
            let hit = false;
            for (let n of nodes) {
                const p = project(n.x, n.y, n.z);
                const d = Math.hypot(p.x - mx, p.y - my);
                if (d < n.size * p.scale + 25) {
                    selected = selected === n.id ? null : n.id;
                    showNodeDetails(selected !== null ? nodes[selected] : null);
                    hit = true;
                    break;
                }
            }
            if (!hit) {
                selected = null;
                showNodeDetails(null);
            }
        });
        
        function showNodeDetails(node) {
            const panel = document.getElementById('detailPanel');
            const detailName = document.getElementById('detailName');
            const detailType = document.getElementById('detailType');
            const detailDesc = document.getElementById('detailDesc');
            const detailConnections = document.getElementById('detailConnections');
            
            if (!node) {
                panel.classList.add('is-empty');
                detailName.textContent = '';
                detailType.textContent = '';
                detailDesc.textContent = '';
                detailConnections.innerHTML = '';
                return;
            }
            
            panel.classList.remove('is-empty');
            detailName.textContent = node.name;
            detailType.textContent = `Type: ${node.type.charAt(0).toUpperCase() + node.type.slice(1)}`;
            detailDesc.textContent = node.desc;
            
            // Find connected nodes
            const connected = [];
            edges.forEach(e => {
                if (e.from === node.id) {
                    const target = nodes[e.to];
                    connected.push(`‚Üí ${target.name} (${target.type})`);
                } else if (e.to === node.id) {
                    const source = nodes[e.from];
                    connected.push(`‚Üê ${source.name} (${source.type})`);
                }
            });
            
            detailConnections.innerHTML = connected.length > 0 
                ? connected.map(c => `<div style="margin: 4px 0; color: #00ffff;">${c}</div>`).join('')
                : '<div style="color: #666;">No connections</div>';
        }

        canvas.addEventListener('wheel', e => {
            e.preventDefault();
            // Trackpad pinch (Mac: ctrlKey set) ‚Äî pinch out = zoom in (dist down)
            const zoomSpeed = 10;
            if (e.ctrlKey) {
                camera.dist -= e.deltaY * zoomSpeed;
            } else {
                camera.dist += e.deltaY * zoomSpeed;
            }
            camera.dist = Math.max(5, Math.min(1500, camera.dist));
        });

        let pinchDist = null;
        function pinchDistance(touches) {
            return Math.hypot(touches[0].clientX - touches[1].clientX, touches[0].clientY - touches[1].clientY);
        }
        canvas.addEventListener('touchstart', e => {
            if (e.touches.length === 2) {
                pinchDist = pinchDistance(e.touches);
                e.preventDefault();
            }
        }, { passive: false });
        canvas.addEventListener('touchmove', e => {
            if (e.touches.length !== 2) return;
            e.preventDefault();
            const d = pinchDistance(e.touches);
            if (pinchDist === null) { pinchDist = d; return; }
            // Pinch out (spread) = zoom in. Pinch in (together) = zoom out. Set to -1 if that feels backwards.
            const pinchZoomInvert = 1;
            camera.dist += (pinchDist - d) * 2.5 * pinchZoomInvert;
            camera.dist = Math.max(5, Math.min(1500, camera.dist));
            pinchDist = d;
        }, { passive: false });
        canvas.addEventListener('touchend', e => {
            if (e.touches.length < 2) pinchDist = null;
        }, { passive: true });

        let drag = null;
        canvas.addEventListener('mousedown', e => {
            drag = {x: e.clientX, y: e.clientY};
        });
        document.addEventListener('mousemove', e => {
            if (drag) {
                camera.angle += (e.clientX - drag.x) * 0.012;
                camera.pitch += (e.clientY - drag.y) * 0.008;
                camera.pitch = Math.max(-1.2, Math.min(1.2, camera.pitch));
                drag = {x: e.clientX, y: e.clientY};
            }
        });
        document.addEventListener('mouseup', () => {
            drag = null;
        });

        window.walk = () => {
            selected = Math.floor(Math.random() * nodes.length);
            showNodeDetails(nodes[selected]);
        };

        window.reset = () => {
            camera = {angle: 0.5, dist: 480, height: 0, pitch: 0};
            selected = null;
            showNodeDetails(null);
        };

        // Initial load: pick a random node and show its info
        selected = Math.floor(Math.random() * nodes.length);
        showNodeDetails(nodes[selected]);

        render();
    </script>
</body>
</html>
